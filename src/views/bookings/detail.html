{% extends "base.html" %}

{% block title %}Booking {{ booking.id }} - IU Campus Resource Hub{% endblock %}

{% block content %}
<div class="container" style="margin-top: 40px; margin-bottom: 64px;">
    <!-- Back Button -->
    <a href="{{ url_for('bookings.list') }}" style="display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none; margin-bottom: 32px; font-size: 14px; font-weight: 500;">
        <i class="bi bi-arrow-left"></i> Back to My Bookings
    </a>

    <!-- Header -->
    <div style="margin-bottom: 40px;">
        <h1 style="font-size: 36px; font-weight: 700; color: var(--text-primary); margin: 0 0 16px 0;">
            <i class="bi bi-calendar-check-fill text-crimson"></i> Booking #{{ booking.id }}
        </h1>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
            <span class="badge-iu {% if booking.status.value == 'approved' %}badge-iu-success{% elif booking.status.value == 'pending' %}badge-iu-warning{% elif booking.status.value == 'completed' %}badge-iu-light{% else %}badge-iu-crimson{% endif %}" style="font-size: 16px; padding: 10px 20px;">
                {{ booking.status.value|title }}
            </span>
            <a href="{{ url_for('resources.detail', resource_id=booking.resource_id) }}" style="color: var(--iu-crimson); text-decoration: none; font-weight: 500; font-size: 16px;">
                <i class="bi bi-building-fill"></i> {{ resource.title }}
            </a>
        </div>
    </div>

    {% if booking.status.value == 'pending' %}
    <div class="alert-iu alert-iu-warning" style="margin-bottom: 32px; padding: 20px;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div>
            <strong>Pending Approval:</strong> This booking is awaiting approval from an administrator.
        </div>
    </div>
    {% endif %}

    {% if has_conflict_warning %}
    <div class="alert-iu alert-iu-error" style="margin-bottom: 32px; padding: 20px;">
        <i class="bi bi-exclamation-circle-fill"></i>
        <div>
            <strong>Conflict Warning:</strong> This booking may conflict with other bookings. Please review.
        </div>
    </div>
    {% endif %}

    <!-- Main Content: 2 Column Layout -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px; align-items: start;">
        <!-- Left Column: Details -->
        <div>
            <!-- Booking Information Card -->
            <div class="card-iu" style="margin-bottom: 32px; padding: 32px;">
                <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 28px;">
                    <i class="bi bi-info-circle-fill text-crimson"></i> Booking Information
                </h2>
                
                <div style="display: grid; gap: 28px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 28px;">
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Resource</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">
                                <a href="{{ url_for('resources.detail', resource_id=booking.resource_id) }}" style="color: var(--iu-crimson); text-decoration: none;">
                                    {{ resource.title }}
                                </a>
                            </p>
                        </div>
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Requester</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">{{ booking.user.email }}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 28px;">
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Start Date & Time</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">{{ booking.start_dt.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">End Date & Time</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">{{ booking.end_dt.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 28px;">
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Duration</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">{{ ((booking.end_dt - booking.start_dt).total_seconds() / 3600)|round(1) }} hours</p>
                        </div>
                        <div>
                            <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Created</p>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">{{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Timeline -->
            <div class="card-iu" style="margin-bottom: 32px; padding: 32px;">
                <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 28px;">
                    <i class="bi bi-clock-history text-crimson"></i> Status Timeline
                </h2>
                
                <div style="display: grid; gap: 20px;">
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Created</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">{{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    
                    {% if booking.status.value == 'pending' %}
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--warning); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Pending Approval</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">Awaiting staff/admin approval</p>
                        </div>
                    </div>
                    {% elif booking.status.value == 'approved' %}
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Approved</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">{{ booking.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    {% elif booking.status.value == 'rejected' %}
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--error); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Rejected</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">{{ booking.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    {% elif booking.status.value == 'completed' %}
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Completed</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">{{ booking.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    {% elif booking.status.value == 'cancelled' %}
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="width: 10px; height: 10px; background: var(--error); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                        <div>
                            <strong style="display: block; margin-bottom: 6px; font-size: 15px;">Cancelled</strong>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">{{ booking.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Messages Preview -->
            {% if message_count > 0 and booking.status.value == 'pending' and (current_user.role.value == 'admin' or resource.created_by == current_user.id) %}
            <div class="card-iu" style="border-left: 3px solid var(--info); margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                    <i class="bi bi-chat-dots-fill text-crimson"></i> Recent Messages
                    <span class="badge-iu badge-iu-info">{{ message_count }}</span>
                </h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                    Review messages from the requester before approving or rejecting this booking.
                </p>
                {% if recent_messages %}
                <div style="display: grid; gap: 12px; max-height: 300px; overflow-y: auto;">
                    {% for message in recent_messages %}
                    {% set is_requester = message.sender_id == booking.user_id %}
                    <div style="background: {{ '#FFF8F0' if is_requester else '#F0F4FF' }}; padding: 12px; border-radius: var(--border-radius); border-left: 3px solid {{ 'var(--info)' if is_requester else 'var(--iu-crimson)' }};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <strong style="font-size: 14px;">
                                {% if is_requester %}
                                <i class="bi bi-person-fill"></i> {{ message.sender.email }} (Requester)
                                {% else %}
                                <i class="bi bi-shield-check-fill"></i> {{ message.sender.email }}
                                {% endif %}
                            </strong>
                            <small style="color: var(--text-muted); font-size: 12px;">{{ message.created_at.strftime('%b %d, %I:%M %p') }}</small>
                        </div>
                        <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">{{ message.body }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% if message_count > 3 %}
                <div style="margin-top: 16px;">
                    <a href="{{ url_for('messaging.list_messages', booking_id=booking.id) }}" class="btn-iu btn-iu-secondary">
                        <i class="bi bi-chat-left-text-fill"></i> View All {{ message_count }} Messages
                    </a>
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Actions -->
        <div style="position: sticky; top: 110px;">
            {% if current_user.is_authenticated %}
            <div class="card-iu" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px;">
                    <i class="bi bi-gear-fill text-crimson"></i> Actions
                </h3>

                {% set can_approve = (booking.status.value == 'pending' and current_user.role.value == 'admin') %}
                {% if can_approve %}
                <div class="alert-iu alert-iu-warning" style="margin-bottom: 24px; padding: 16px; font-size: 13px;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <div>
                        <strong>Approval Required</strong>
                        <p style="margin: 6px 0 0 0; font-size: 12px;">
                            As an Administrator, you can approve or reject this booking.
                        </p>
                    </div>
                </div>
                
                <div style="display: grid; gap: 16px; margin-bottom: 28px;">
                    <form method="POST" action="{{ url_for('bookings.approve', booking_id=booking.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn-iu btn-iu-primary" style="width: 100%; padding: 14px 20px;">
                            <i class="bi bi-check-circle-fill"></i> Approve Booking
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('bookings.reject', booking_id=booking.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn-iu btn-iu-outline" style="width: 100%; padding: 14px 20px;" onclick="return confirm('Are you sure you want to reject this booking?')">
                            <i class="bi bi-x-circle-fill"></i> Reject Booking
                        </button>
                    </form>
                </div>
                {% endif %}

                {% if booking.status.value == 'approved' and current_user.role.value == 'admin' %}
                <div style="margin-bottom: 28px; padding-bottom: 28px; border-bottom: 1px solid var(--border-color);">
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        <i class="bi bi-info-circle-fill"></i> Mark booking as completed after the event.
                    </p>
                    <form method="POST" action="{{ url_for('bookings.complete', booking_id=booking.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn-iu btn-iu-secondary" style="width: 100%; padding: 14px 20px;" onclick="return confirm('Mark this booking as completed?')">
                            <i class="bi bi-check2-all"></i> Mark as Completed
                        </button>
                    </form>
                </div>
                {% endif %}

                {% set can_cancel = (booking.user_id == current_user.id and booking.status.value in ['pending', 'approved']) or current_user.role.value == 'admin' %}
                {% if can_cancel and booking.status.value not in ['cancelled', 'completed'] %}
                <div style="margin-bottom: 28px;">
                    {% if booking.user_id == current_user.id %}
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        <i class="bi bi-info-circle-fill"></i> You can cancel your own booking.
                    </p>
                    {% elif current_user.role.value == 'admin' %}
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        <i class="bi bi-shield-check-fill"></i> Admin override: You can cancel this booking.
                    </p>
                    {% endif %}
                    <form method="POST" action="{{ url_for('bookings.cancel', booking_id=booking.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn-iu btn-iu-outline" style="width: 100%; padding: 14px 20px;" onclick="return confirm('Are you sure you want to cancel this booking?')">
                            <i class="bi bi-x-octagon-fill"></i> Cancel Booking
                        </button>
                    </form>
                </div>
                {% endif %}

                {% if current_user.role.value == 'student' and booking.status.value == 'pending' %}
                <div class="alert-iu alert-iu-info" style="font-size: 13px; padding: 16px; margin-bottom: 28px;">
                    <i class="bi bi-hourglass-split"></i>
                    <span>Your booking is pending approval</span>
                </div>
                {% endif %}

                <!-- Messages Link -->
                <div style="margin-top: 28px; padding-top: 28px; border-top: 1px solid var(--border-color);">
                    <a href="{{ url_for('messaging.list_messages', booking_id=booking.id) }}" class="btn-iu btn-iu-primary" style="width: 100%; padding: 14px 20px;">
                        <i class="bi bi-chat-fill"></i> Open Messages
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
