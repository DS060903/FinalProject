{% extends "base.html" %}

{% block title %}My Conversations - IU Campus Resource Hub{% endblock %}

{% block content %}
<div class="container" style="margin-top: 32px; margin-bottom: 48px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 32px;">
    <div>
            <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin: 0 0 8px 0;">
                <i class="bi bi-chat-dots-fill text-crimson"></i> My Conversations
            </h1>
            <p style="color: var(--text-secondary); margin: 0;">
                {{ bookings_with_messages|length }} active conversation{{ 's' if bookings_with_messages|length != 1 else '' }}
            </p>
    </div>
        <div style="display: flex; gap: 12px;">
            <a href="{{ url_for('bookings.list') }}" class="btn-iu btn-iu-outline">
                <i class="bi bi-calendar-check-fill"></i> My Bookings
            </a>
    {% if current_user.role.value == 'admin' %}
            <a href="{{ url_for('admin.messages') }}" class="btn-iu btn-iu-outline">
                <i class="bi bi-shield-lock-fill"></i> Flagged Messages
    </a>
    {% endif %}
</div>
    </div>

{% if bookings_with_messages %}
    <!-- Conversations Grid -->
    <div class="grid-iu" style="gap: 24px;">
    {% for item in bookings_with_messages %}
        <div class="card-iu" style="padding: 32px;">
            <!-- Card Header -->
            <div style="background: linear-gradient(135deg, var(--iu-crimson) 0%, var(--iu-crimson-dark) 100%); padding: 24px; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; margin: -32px -32px 28px -32px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 20px; font-weight: 600; color: white; margin: 0;">
                        <i class="bi bi-chat-fill"></i> Booking #{{ item.booking.id }}
                    </h3>
                    <span class="badge-iu badge-iu-light" style="font-size: 14px; padding: 8px 12px;">
                        <i class="bi bi-envelope-fill"></i> {{ item.message_count }}
                    </span>
                </div>
            </div>
            
            <div class="card-iu-body" style="padding: 0;">
                <!-- Resource Info -->
                <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color);">
                    <div style="background: #FFF8F0; padding: 16px; border-radius: var(--border-radius);">
                        <i class="bi bi-building-fill" style="font-size: 28px; color: var(--iu-crimson);"></i>
                    </div>
                    <div style="flex: 1;">
                        <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Resource</p>
                        <a href="{{ url_for('resources.detail', resource_id=item.booking.resource_id) }}" style="color: var(--iu-crimson); text-decoration: none; font-weight: 600; font-size: 18px; line-height: 1.4;">
                            {{ item.booking.resource.title }}
                        </a>
                    </div>
                </div>
                
                <!-- Booking Details -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div>
                        <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Date</p>
                        <p style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 16px;">{{ item.booking.start_dt.strftime('%b %d, %Y') }}</p>
                    </div>
                    <div>
                        <p class="form-label-iu" style="margin-bottom: 8px; font-size: 13px;">Status</p>
                        <span class="badge-iu {% if item.booking.status.value == 'approved' %}badge-iu-success{% elif item.booking.status.value == 'pending' %}badge-iu-warning{% elif item.booking.status.value == 'completed' %}badge-iu-light{% else %}badge-iu-crimson{% endif %}" style="font-size: 14px; padding: 8px 12px;">
                    {{ item.booking.status.value|title }}
                        </span>
                    </div>
                </div>
                
                <!-- Last Message Preview -->
                {% if item.last_message %}
                <div style="background: #FFF8F0; padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--iu-crimson); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <small style="color: var(--text-muted); font-size: 13px; font-weight: 500;">
                            <i class="bi bi-clock-fill"></i> Latest message
                        </small>
                        <small style="color: var(--text-muted); font-size: 13px;">{{ item.last_message.created_at.strftime('%b %d, %I:%M %p') }}</small>
                    </div>
                    <p style="margin: 0; font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
                        {% if item.last_message.sender_id == current_user.id %}
                        <strong style="color: var(--text-primary);">You:</strong>
                        {% else %}
                        <strong style="color: var(--text-primary);">{{ item.last_message.sender.email.split('@')[0] }}:</strong>
                        {% endif %}
                        {{ item.last_message.body }}
                    </p>
                </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div style="display: grid; gap: 12px;">
                    <a href="{{ url_for('messaging.list_messages', booking_id=item.booking.id) }}" class="btn-iu btn-iu-primary" style="padding: 14px 20px; font-size: 15px;">
                        <i class="bi bi-chat-text-fill"></i> Open Conversation
                    </a>
                    <a href="{{ url_for('bookings.detail', booking_id=item.booking.id) }}" class="btn-iu btn-iu-secondary" style="padding: 12px 20px; font-size: 14px;">
                        <i class="bi bi-info-circle-fill"></i> View Booking Details
                    </a>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% else %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 80px 24px; background: white; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm);">
        <i class="bi bi-chat-dots" style="font-size: 64px; color: var(--border-color); margin-bottom: 24px; display: block;"></i>
        <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">No Conversations Yet</h3>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
            Messages will appear here once you start a conversation about a booking.<br>
            Book a resource and send a message to get started!
        </p>
        <a href="{{ url_for('resources.list_resources') }}" class="btn-iu btn-iu-primary">
            <i class="bi bi-search"></i> Browse Resources
        </a>
</div>
{% endif %}
</div>
{% endblock %}
