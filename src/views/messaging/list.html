{% extends "base.html" %}

{% block title %}Messages for Booking {{ booking.id }} - IU Campus Resource Hub{% endblock %}

{% block content %}
<div class="container" style="margin-top: 32px; margin-bottom: 48px; max-width: 900px;">
    <!-- Header -->
    <div style="margin-bottom: 32px;">
        <a href="{{ url_for('bookings.detail', booking_id=booking.id) }}" style="display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none; margin-bottom: 16px; font-size: 14px; font-weight: 500;">
            <i class="bi bi-arrow-left"></i> Back to Booking
        </a>
        <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin: 0 0 8px 0;">
            <i class="bi bi-chat-dots-fill text-crimson"></i> Messages for Booking #{{ booking.id }}
        </h1>
        <p style="color: var(--text-secondary); margin: 0;">Communicate with the resource owner or admin</p>
    </div>

    <!-- Send Message Card -->
    {% if booking.status.value not in ['cancelled', 'rejected'] %}
    <div class="card-iu" style="margin-bottom: 32px; padding: 32px;">
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">
            <i class="bi bi-send-fill text-crimson"></i> Send Message
        </h2>
        <form method="POST" action="{{ url_for('messaging.create_message', booking_id=booking.id) }}" aria-label="Send message form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="form-group-iu">
                <label class="form-label-iu">
                    <i class="bi bi-chat-text-fill"></i> Message
                </label>
                <textarea class="form-control-iu" id="body" name="body" rows="4" required aria-required="true" placeholder="Type your message here..." maxlength="2000"></textarea>
                <p class="form-text-iu">Maximum 2000 characters</p>
            </div>
            
            <button type="submit" class="btn-iu btn-iu-primary">
                <i class="bi bi-send-fill"></i> Send Message
            </button>
        </form>
    </div>
    {% else %}
    <div class="alert-iu alert-iu-warning" style="margin-bottom: 32px;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div>
            <strong>Messages Disabled:</strong> Messages cannot be sent for {{ booking.status.value }} bookings.
        </div>
    </div>
    {% endif %}
    
    <!-- Message History Card -->
    <div class="card-iu" style="padding: 32px;">
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">
            <i class="bi bi-chat-left-text-fill text-crimson"></i> Message History
        </h2>
        
        {% if messages %}
        <div style="display: grid; gap: 20px;">
            {% for message in messages %}
            <div style="padding: 20px; background: #FFF8F0; border-radius: var(--border-radius); border-left: 3px solid var(--iu-crimson);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-person-circle-fill" style="color: var(--text-secondary); font-size: 20px;"></i>
                        <div>
                            <strong style="color: var(--text-primary); font-size: 15px;">{{ message.sender.email }}</strong>
                            <div style="margin-top: 4px;">
                                <span class="badge-iu badge-iu-info" style="font-size: 11px; padding: 3px 8px;">{{ message.sender.role.value|title }}</span>
                            </div>
                        </div>
                    </div>
                    <small style="color: var(--text-muted); font-size: 13px;">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                <p style="margin: 0; color: var(--text-secondary); line-height: 1.6; font-size: 15px;">{{ message.body }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="bi bi-chat-dots" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
            <p style="margin: 0; font-size: 15px;">No messages yet. Start the conversation by sending a message above.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
